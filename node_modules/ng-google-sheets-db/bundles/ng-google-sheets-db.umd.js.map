{"version":3,"file":"ng-google-sheets-db.umd.js","sources":["../../../projects/ng-google-sheets-db/src/lib/google-sheets-db.service.ts","../../../projects/ng-google-sheets-db/src/public-api.ts","../../../projects/ng-google-sheets-db/src/ng-google-sheets-db.ts"],"sourcesContent":["import { Observable, throwError } from 'rxjs';\nimport { map, catchError } from 'rxjs/operators';\n\nimport { InjectionToken, Injectable, Inject } from '@angular/core';\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\n\nexport interface GoogleSpreadsheetsResponse {\n  values: string[][];\n}\n\nexport const API_KEY = new InjectionToken<string>('Google Sheets API key');\n\n@Injectable({\n  providedIn: 'root',\n})\nexport class GoogleSheetsDbService {\n  defaultActiveValues: any[] = ['true', '1', 'yes'];\n\n  constructor(\n    private http: HttpClient,\n    @Inject(API_KEY) public apiKey: string\n  ) {}\n\n  public get<T>(\n    spreadsheetId: string,\n    worksheetName: string,\n    attributesMapping: object | string[]\n  ): Observable<T[]> {\n    return this.getRows(spreadsheetId, worksheetName).pipe(\n      map((rows: string[][]) =>\n        this.rowsToEntries(rows).map(\n          (entry: object) =>\n            this.getObjectFromEntry(entry, attributesMapping) as T\n        )\n      )\n    );\n  }\n\n  public getActive<T>(\n    spreadsheetId: string,\n    worksheetName: string,\n    attributesMapping: object | string[],\n    isActiveColumnName: string = 'is_active',\n    activeValues: string[] | string = null\n  ): Observable<T[]> {\n    if (activeValues === null) {\n      activeValues = this.defaultActiveValues;\n    } else if (!Array.isArray(activeValues)) {\n      activeValues = [activeValues];\n    }\n    return this.getRows(spreadsheetId, worksheetName).pipe(\n      map((rows: string[][]) =>\n        this.rowsToEntries(rows)\n          .filter((obj: object) =>\n            activeValues.includes(obj[isActiveColumnName].toLowerCase())\n          )\n          .map(\n            (entry: object) =>\n              this.getObjectFromEntry(entry, attributesMapping) as T\n          )\n      )\n    );\n  }\n\n  private getSpreadsheetUrl(\n    spreadsheetId: string,\n    worksheetName: string\n  ): string {\n    return (\n      'https://sheets.googleapis.com/v4/spreadsheets/' +\n      spreadsheetId +\n      '/values/' +\n      encodeURI(worksheetName) +\n      '?key=' +\n      this.apiKey\n    );\n  }\n\n  private getRows(\n    spreadsheetId: string,\n    worksheetName: string\n  ): Observable<string[][]> {\n    const spreadsheetUrl = this.getSpreadsheetUrl(spreadsheetId, worksheetName);\n\n    return this.http.get<GoogleSpreadsheetsResponse>(spreadsheetUrl).pipe(\n      map((jsonRes) => jsonRes.values),\n      catchError(this.handleError)\n    );\n  }\n\n  public rowsToEntries(rows: string[][]): object[] {\n    const columns: Array<string> = rows[0].map(this.cleanColumnName);\n    return rows.slice(1).map((row: Array<string>) =>\n      columns.reduce((entry: object, columnName: string, idx: number) => {\n        entry[columnName] = row.length > idx ? row[idx] : '';\n        return entry;\n      }, {})\n    );\n  }\n\n  public cleanColumnName(columnName: string): string {\n    return columnName.trim();\n  }\n\n  private arrayToObject(array: string[]): object {\n    return array.reduce((acc, cur) => {\n      acc[cur] = cur;\n      return acc;\n    }, {});\n  }\n\n  private getObjectFromEntry(\n    entry: object,\n    attributesMapping: object | string[]\n  ): unknown {\n    if (Array.isArray(attributesMapping)) {\n      attributesMapping = this.arrayToObject(attributesMapping);\n    }\n\n    return this.getObjectFromEntryObject(entry, attributesMapping);\n  }\n\n  private getObjectFromEntryObject(\n    entry: object,\n    attributesMapping: object,\n    columnNamePrefix: string = ''\n  ): object {\n    const obj: object = {};\n    for (const attr in Object(attributesMapping)) {\n      if (\n        attributesMapping.hasOwnProperty(attr) &&\n        !['_prefix', '_listField'].includes(attr)\n      ) {\n        if (typeof attributesMapping[attr] === 'string') {\n          obj[attr] = this.getValueFromEntry(\n            entry,\n            columnNamePrefix + attributesMapping[attr]\n          );\n        } else if (typeof attributesMapping[attr] === 'object') {\n          let columnName = '';\n          if (attributesMapping[attr].hasOwnProperty('_prefix')) {\n            columnName = attributesMapping[attr]._prefix;\n          }\n\n          if (attributesMapping[attr]._listField) {\n            obj[attr] = this.getListFromEntry(\n              entry,\n              columnNamePrefix + columnName\n            );\n          } else {\n            obj[attr] = this.getObjectFromEntryObject(\n              entry,\n              attributesMapping[attr],\n              columnNamePrefix + columnName\n            );\n          }\n        } else {\n          console.log(`Unknown type for ${attr}`);\n        }\n      }\n    }\n\n    return obj;\n  }\n\n  private getValueFromEntry(entry: object, attribute: string): string {\n    attribute = this.cleanColumnName(attribute);\n    if (entry.hasOwnProperty(attribute)) {\n      return entry[attribute];\n    } else {\n      return null;\n    }\n  }\n\n  private getListFromEntry(entry: object, attribute: string): string[] {\n    const list: string[] = [];\n\n    let i = 1;\n    let curElement: string = this.getValueFromEntry(entry, `${attribute}${i}`);\n    while (curElement) {\n      list.push(curElement);\n      i++;\n      curElement = this.getValueFromEntry(entry, `${attribute}${i}`);\n    }\n\n    return list;\n  }\n\n  private handleError(error: HttpErrorResponse): Observable<never> {\n    if (error.error instanceof ErrorEvent) {\n      console.error('An error occurred:', error.error.message);\n    } else {\n      console.error(\n        `Backend returned code ${error.status}, body was: ${error.error}`\n      );\n    }\n    return throwError('Something bad happened; please try again later.');\n  }\n}\n","/*\n * Public API Surface of ng-google-sheets-db\n */\n\nexport { GoogleSheetsDbService, API_KEY } from './lib/google-sheets-db.service';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":["InjectionToken","map","catchError","throwError","Injectable","HttpClient","Inject"],"mappings":"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"}